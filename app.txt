window.onload = function () {
  var game = new Phaser.Game(800,600, Phaser.AUTO, "", { preload: preload, create:create, update: update});
  var platforms;
  var player;
  var star;
  var cursors;
  var levels = [];
  var currentLevel = 0;

  function preload(){
    game.load.spritesheet("dude", "assets/dude.png", 32, 48);
    game.load.image("sky", "assets/sky.png");
    game.load.image("tile", "assets/tile_1.png");
    game.load.image("star", "assets/star.png");
  }

  function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.add.sprite(0, 0, "sky");

    platforms = game.add.group();
    platforms.enableBody = true;

    star = game.add.group();
    star.enableBody = true;

    cursors = game.input.keyboard.createCursorKeys();

    player = game.add.sprite(32, game.world.height - 150, "dude");
    game.physics.arcade.enable(player);

    levels.push(new LevelOne({
      platforms: platforms,
      star: star,
      cursors: cursors,
      player: player
    }));

    levels.push(new LevelTwo({
      platforms: platforms,
      star: star,
      cursors: cursors,
      player: player
    }));



    levels[currentLevel].create();
  }

  function update() {
    var hitPlatform = game.physics.arcade.collide(player, platforms);
    game.physics.arcade.overlap(player, star, changeLevel, null, this);
    game.physics.arcade.collide(star, platforms);

    player.body.velocity.x = 0;

    if (cursors.left.isDown) {
      player.body.velocity.x = -150;
      player.animations.play("left");
    } else if (cursors.right.isDown) {
      player.body.velocity.x = 150;
      player.animations.play("right");
    } else {
      player.animations.stop();
      player.frame = 4;
    }

    if (cursors.up.isDown && player.body.touching.down && hitPlatform) {
      player.body.velocity.y = -280;
    }
  }

  function changeLevel() {
    levels[currentLevel].cleanup(this);
    currentLevel++;
    levels[currentLevel].create(this);
  }

  function LevelOne(options) {
    this.platforms = options.platforms;
    this.player = options.player;
    this.cursors = options.cursors;
    this.star = options.star;


    this.create = function () {
      var ground;

      // Create the platforms
      for (var i = 0; i < 25; i++) {
        ground = this.platforms.create(i*32, game.world.height - 32, "tile");
        ground.body.immovable = true;
      }

      ground = this.platforms.create(21*32, game.world.height - 5*32, "tile");
      ground.body.immovable = true;

      ground = this.platforms.create(14*32, game.world.height - 8*32, "tile");

      ground = this.platforms.create(8*32, game.world.height - 11*32, "tile");
      ground.body.immovable = true;

      ground = this.platforms.create(7*32, game.world.height - 11*32, "tile");
      ground.body.immovable = true;

      endLevelStar = this.star.create(7.5*32, game.world.height - 13*32, "star");
      endLevelStar.body.gravity.y = 100;
      endLevelStar.body.bounce = 0.2;

      this.player.body.bounce.y = 0.2;
      this.player.body.gravity.y = 300;
      this.player.body.collideWorldBounds = true;
      this.player.animations.add("left", [0, 1, 2, 3], 10, true);
      this.player.animations.add("right", [5, 6, 7, 8], 10, true);
    }

    this.cleanup = function () {
      this.platforms.callAll("kill");
      this.player.kill();
      this.star.callAll("kill");
    }
  }

  function LevelTwo() {
    this.create = function () {

    }

    this.cleanup = function () {
      
    }
  }
}
